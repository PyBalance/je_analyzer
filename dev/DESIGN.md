### **命令行财务数据分析应用 - 设计文档 (cutword 修订版)**

#### **1. 项目概述**

本项目旨在开发一个基于命令行的应用程序，用于对财务会计中的"叙事账 (Journal Entries)"进行快速分析和筛选。用户通过输入结构化的日记账数据文件，并指定科目、时间范围和分析选项，程序将返回指定的统计概览或数据子集，以满足审计和数据分析的需求。

该程序将使用 Python 语言开发，并以 Pandas 库作为核心数据处理引擎。

#### **2. 核心功能**

  * **数据概览 (Overview):** 对指定科目在特定时间范围内的数据进行统计汇总。
  * **Top N 查询 (Top N):** 检索并显示金额最大（借方、贷方或双向）的 N 条分录。
  * **高级筛选 (Query):** 基于强大的查询表达式，对数据进行灵活的深度筛选。
  * **自定义输出 (Customizable Output):** 用户可以精确控制输出结果中包含的列。

#### **3. 命令行接口设计 (CLI)**

程序通过一系列的参数和子命令来接收用户的指令。

  * **基本语法:**

    ```bash
    python je_analyzer.py <input_file> <command> [options]
    ```

  * **参数说明:**

      * `<input_file>`: 必需。包含会计分录数据的源文件路径（如 `journal_entries.xlsx`）。
      * `<command>`: 必需。指定要执行的操作，可以是 `overview` 或 `get`。

  * **全局选项 (适用于所有命令):**

      * `-a, --account-code <CODE>`: 必需。指定要分析的会计科目编码。
      * `--exact-match`: 可选。指定科目编码匹配模式。如果提供此选项，则要求科目编码完全相等；如果不提供，则使用前缀匹配（startswith）。
      * `-s, --start-date <YYYY-MM-DD>`: 必需。指定分析期间的开始日期。
      * `-e, --end-date <YYYY-MM-DD>`: 必需。指定分析期间的结束日期。
      * `-q, --query <QUERY_STRING>`: 可选。提供一个 Pandas `query()` 方法兼容的查询字符串，用于在基础筛选（科目和日期）之上进行额外筛选。
      * `-b, --account-book <NAME>`: 必需。指定要分析的账套名称。支持以下格式：
          * `"账套A"`: 指定单个账套
          * `"账套A,账套B"`: 指定多个账套，用逗号分隔
          * `"all"`: 分析所有账套

  * **命令一: `overview`**
    生成并显示指定范围内的统计概览。

      * **用法:**
        ```bash
        python je_analyzer.py <input_file> overview -a <CODE> -s <START> -e <END> -b <BOOK>
        ```
      * **功能:** 此命令将输出一个多维度的统计报告。

  * **命令二: `get`**
    获取、筛选并输出原始数据行。

      * **用法:**
        ```bash
        python je_analyzer.py <input_file> get -a <CODE> -s <START> -e <END> -b <BOOK> [get-options]
        ```
      * **`get` 命令专属选项:**
          * `--top <N>`: 可选。指定此选项后，将返回 Top N 条记录。如果省略，则返回所有符合条件的记录。
          * `--top-type <TYPE>`: 可选，与 `--top` 配合使用。定义 Top N 的排序依据。
              * `debit`: 按借方金额降序排序。
              * `credit`: 按贷方金额降序排序。
              * `both`: 按借方或贷方金额的绝对值降序排序。
              * 默认值为 `both`。
          * `--columns <COL_CONFIG>`: 可选。控制输出哪些列。
              * `all`: 输出源文件中的所有列。
              * `default`: 输出一组预定义的默认列（详见 4.5 节）。
              * `"col1,col2,col3"`: 用户提供一个以逗号分隔的列名字符串，精确指定要输出的列。
              * 默认值为 `default`。

#### **4. 功能详细说明**

##### **4.1 数据输入**

  * 程序应能接受 Excel 文件格式（.xlsx）。
  * 推荐使用 `calamine` 引擎读取大型 Excel 文件以提高性能。
  * **数据类型处理**: 程序读取Excel文件时，先将所有数据作为字符串类型读取，然后进行以下类型转换：
      * `日期` 列：转换为 Pandas datetime 类型
      * `借方金额` 列：转换为 float 类型
      * `贷方金额` 列：转换为 float 类型
      * `借正贷负` 列：转换为 float 类型
      * 其他列保持为字符串类型
  * 输入数据应包含如 `凭证唯一号`, `日期`, `科目编码`, `科目全称`, `摘要`, `借方金额`, `贷方金额`, `客户名称`, `供应商名称` 等核心字段。
  * **注意：** 程序在加载数据时应妥善处理列名中可能存在的前后空格，例如表头中的 `借方金额` 和 `贷方金额`。

##### **4.2 筛选逻辑与执行顺序**

程序的内部处理流程遵循以下顺序：

1.  **加载源数据文件到 Pandas DataFrame**，并清理列名中的首尾空格。
2.  **基础筛选**: 首先根据用户提供的 `--account-code`, `--start-date`, `--end-date`, `--account-book` 筛选出基础数据子集：
      * **科目编码筛选**: 如果提供了 `--exact-match` 选项，则要求科目编码完全相等；否则使用前缀匹配（startswith）。
      * **日期范围筛选**: 筛选指定日期范围内的记录。
      * **账套名称筛选**:
          * 如果是 `"all"`，则包含所有账套
          * 如果包含逗号，则按多个账套筛选
          * 否则按单个账套名称筛选
3.  **高级筛选**: 如果用户提供了 `--query` 选项，则在第一步筛选结果的基础上，应用该查询字符串进行二次筛选。
4.  **执行操作**: 在最终筛选出的数据上执行 `overview` 或 `get` 操作。

##### **4.3 `overview` 功能详解**

`overview` 命令的输出应包含以下几个部分：

  * **基本统计:**
      * **总行数:** 经过筛选后，符合条件的总分录行数。
  * **借方金额分布 (Debit Distribution):**
      * **平均值 (Average):** 所有借方金额的算术平均值。
      * **众数 (Mode):** 出现频率最高的借方金额。
      * **众数频率 (Mode Frequency):** 该众数出现的次数。
  * **贷方金额分布 (Credit Distribution):**
      * **平均值 (Average):** 所有贷方金额的算术平均值。
      * **众数 (Mode):** 出现频率最高的贷方金额。
      * **众数频率 (Mode Frequency):** 该众数出现的次数。
  * **注：** 不计算标准差等复杂统计指标。
  * **摘要列词频分析 (Summary Word Frequency):**
      * 对 `摘要` 列的所有文本进行分词处理，使用 `cutword` 库。
      * 初始化：`cutter = Cutter(want_long_word=True)` 以获取更精确的长词切分。
      * 分词：`words = cutter.cutword(text)` 返回词语列表。
      * 统计词频并显示频率最高的词语及其出现次数。

##### **4.4 `get` 功能详解 (`--top` 选项)**

  * 当用户使用 `--top N` 时：
      * 若 `--top-type` 为 `debit`，则返回按 `借方金额` 列降序排列的前 N 行。
      * 若 `--top-type` 为 `credit`，则返回按 `贷方金额` 列降序排列的前 N 行。
      * 若 `--top-type` 为 `both` 或未指定，则将借方和贷方金额合并（或取绝对值）进行比较，返回金额最高的 N 行记录，总计 N 行。
  * 若不使用 `--top` 选项，则返回所有符合筛选条件的记录。

##### **4.5 输出列控制 (`--columns` 选项)**

  * `--columns all`: 原样输出数据源中的所有列。
  * `--columns "col1,col2"`: 只输出用户指定的 `col1` 和 `col2` 列。
  * `--columns default` (或不指定): 输出以下与表头完全匹配的预设列：
      * `账套名称`
      * `科目编码`
      * `科目全称`
      * `摘要`
      * `凭证唯一号`
      * `凭证行号`
      * `借方金额`
      * `贷方金额`
      * `日期`
      * `客户名称`
      * `供应商名称`
      * `项目名称`
  * **特殊逻辑:** 对于 `default` 模式下的 `客户名称`, `供应商名称`, `项目名称` 这三列，程序在输出前会进行检查。如果某一列的所有行均为空值（无数据），则该列将不会被包含在最终的输出中。

##### **4.6 数据列名注意事项**

  * **精确匹配:** 所有通过 `--query` 和 `--columns` 参数引用的列名，都必须与源文件中的表头 **完全一致**，包括可能存在的空格。
  * **含空格的列名:** 当在 `--query` 字符串中引用含有空格的列名（如 `借方金额`）时，需要用反引号 (`` ` ``) 将其包裹起来，例如 ``  ` 借方金额 ` > 10000 ``。

#### **5. 输出格式**

  * **对于 `get` 命令:** 输出的应是标准、干净的表格数据。默认使用 **Tab (`\t`)** 作为列分隔符，方便用户直接复制或通过管道传递给其他命令行工具进行再处理。
  * **对于 `overview` 命令:** 输出的应是人类可读的、格式化的报告，清晰地展示各个统计项及其数值。

#### **6. 技术栈建议**

  * **语言:** Python 3.x
  * **核心库:** Pandas (用于数据处理和查询)
  * **Excel 读取:** `openpyxl` 和 `calamine` 引擎（用于大型文件）
  * **命令行解析:** `argparse` (Python 标准库) 或 `click` (第三方库，更灵活)
  * **分词:** `cutword` 库，使用 `Cutter(want_long_word=True)` 进行中文分词。

#### **7. 使用示例**

  * **示例 1: 获取某个科目的基本概览**

    ```bash
    python je_analyzer.py journal.xlsx overview \
        -a "6601.01.001" \
        -s "2024-01-01" \
        -e "2024-12-31" \
        -b "主账套"
    ```

  * **示例 2: 查找费用科目中，摘要包含"差旅"且金额最大的 5 笔贷方分录**

    ```bash
    python je_analyzer.py journal.xlsx get \
        -a "6602.05" \
        -s "2024-01-01" \
        -e "2024-03-31" \
        -b "费用账套" \
        --top 5 \
        --top-type "credit" \
        -q "摘要.str.contains('差旅')"
    ```

  * **示例 3: 导出应收账款科目下，所有与特定客户相关且金额大于 10000 的分录，并只显示自定义的几列**

    ```bash
    # 注意在 query 字符串中，含有空格的列名 ` 借方金额 ` 使用了反引号包裹
    python je_analyzer.py journal.xlsx get \
        -a "1122" \
        -s "2024-01-01" \
        -e "2024-12-31" \
        -b "应收账款账套" \
        -q "客户名称 == '某某科技有限公司' and ` 借方金额 ` > 10000" \
        --columns "日期,凭证唯一号,摘要, 借方金额 ,客户名称"
    ```

* **示例 4: 分析多个账套的某个科目概览**

    ```bash
    python je_analyzer.py journal.xlsx overview \
        -a "6601.01.001" \
        -s "2024-01-01" \
        -e "2024-12-31" \
        -b "主账套,备用账套"
    ```

* **示例 5: 分析所有账套的某个科目**

    ```bash
    python je_analyzer.py journal.xlsx overview \
        -a "6601.01.001" \
        -s "2024-01-01" \
        -e "2024-12-31" \
        -b "all"
    ```

* **示例 6: 使用精确匹配筛选特定科目编码**

    ```bash
    python je_analyzer.py journal.xlsx overview \
        -a "6601" \
        --exact-match \
        -s "2024-01-01" \
        -e "2024-12-31" \
        -b "主账套"
    ```

    这只会匹配科目编码完全为 "6601" 的记录，而不会匹配 "6601.01" 或 "6601.02" 等子科目。